<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- –ù–µ–º–Ω–æ–≥–æ –±–∞–∑–æ–≤—ã—Ö —Å—Ç–∏–ª–µ–π, —á—Ç–æ–±—ã –±—ã–ª–æ –Ω–µ —É–∂–∞—Å–Ω–æ -->
  <style>
    body {
      font-family: -apple-system, system-ui, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 12px;
    }
    .search-wrapper {
      margin-bottom: 12px;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      outline: none;
    }
    input[type="text"]:focus {
      border-color: #0088cc;
    }
    .results {
      margin-top: 12px;
    }
    .product {
      background: #fff;
      border-radius: 8px;
      padding: 8px 10px;
      margin-bottom: 6px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      cursor: pointer;
    }
    .product-name {
      font-weight: 500;
      margin-bottom: 4px;
    }
    .product-kbju {
      font-size: 12px;
      color: #555;
    }
    .empty {
      margin-top: 12px;
      font-size: 14px;
      color: #777;
    }
    .selected {
      margin-top: 16px;
      padding: 10px;
      background: #e0f4ff;
      border-radius: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>–ü–æ–∏—Å–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h1>

  <div class="search-wrapper">
    <input
      id="searchInput"
      type="text"
      placeholder="–ù–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞..."
      autocomplete="off"
    >
  </div>

  <div id="results" class="results"></div>
  <div id="selected" class="selected" style="display:none;"></div>

  <!-- Telegram WebApp SDK (—á—Ç–æ–±—ã –≤–Ω—É—Ç—Ä–∏ –¢–ì –≤—Å—ë –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–ª–æ) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    // üëâ –ó–î–ï–°–¨ —É–∫–∞–∂–µ—à—å —Å–≤–æ–π backend
    const API_BASE = "https://shibakovk.app.n8n.cloud/webhook/product_list";

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤ –¢–µ–ª–µ–≥–µ)
    const tg = window.Telegram ? window.Telegram.WebApp : null;
    if (tg) {
      tg.ready();
      // –ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ü–≤–µ—Ç —Ç–µ–º—ã –∏ —Ç.–¥. –ø–æ–∑–∂–µ
    }

    const searchInput = document.getElementById("searchInput");
    const resultsDiv = document.getElementById("results");
    const selectedDiv = document.getElementById("selected");

    let debounceTimer = null;

    // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞
    searchInput.addEventListener("input", () => {
      const query = searchInput.value.trim();

      // –æ—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
      if (debounceTimer) {
        clearTimeout(debounceTimer);
      }

      // –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è ‚Äî –æ—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏ –≤—ã—Ö–æ–¥–∏–º
      if (query.length === 0) {
        resultsDiv.innerHTML = "";
        selectedDiv.style.display = "none";
        return;
      }

      // –¥–µ–±–∞—É–Ω—Å: –ø–æ–¥–æ–∂–¥–∞—Ç—å 200 –º—Å –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
      debounceTimer = setTimeout(() => {
        searchProducts(query);
      }, 200);
    });

    async function searchProducts(query) {
      try {
        const url = API_BASE + "?query=" + encodeURIComponent(query);
        const res = await fetch(url);

        if (!res.ok) {
          throw new Error("–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + res.status);
        }

        const data = await res.json();
        renderResults(data, query);
      } catch (err) {
        console.error(err);
        resultsDiv.innerHTML = "<div class='empty'>–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ, –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ</div>";
      }
    }

    function renderResults(products, query) {
      // –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      if (!products || products.length === 0) {
        resultsDiv.innerHTML = "<div class='empty'>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É: " + escapeHtml(query) + "</div>";
        return;
      }

      // —Å–æ–±–∏—Ä–∞–µ–º HTML
      const html = products.map(p => {
        const kbju = [
          p.kcal_100 != null ? `–ö–∫–∞–ª: ${p.kcal_100}` : null,
          p.protein_100 != null ? `–ë: ${p.protein_100}` : null,
          p.fat_100 != null ? `–ñ: ${p.fat_100}` : null,
          p.carbs_100 != null ? `–£: ${p.carbs_100}` : null,
        ].filter(Boolean).join(" ¬∑ ");

        return `
          <div class="product" data-product="${escapeHtml(p.product)}">
            <div class="product-name">${escapeHtml(p.product)}</div>
            <div class="product-kbju">${kbju}</div>
          </div>
        `;
      }).join("");

      resultsDiv.innerHTML = html;

      // –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –∫–ª–∏–∫–∏
      document.querySelectorAll(".product").forEach(el => {
        el.addEventListener("click", () => {
          const productName = el.getAttribute("data-product");
          onProductClick(productName);
        });
      });
    }

    function onProductClick(productName) {
      // –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–æ
      selectedDiv.style.display = "block";
      selectedDiv.textContent = "–í—ã –≤—ã–±—Ä–∞–ª–∏: " + productName;

      // üëâ –ø–æ–∑–∂–µ —Ç—É—Ç –º–æ–∂–Ω–æ:
      // - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –≤ backend –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
      // - –∑–∞–∫—Ä—ã—Ç—å WebApp (tg.close())
      // - –ø–æ–∫–∞–∑–∞—Ç—å –≤–≤–æ–¥ –≥—Ä–∞–º–º–æ–≤–∫–∏ –∏ —Ç.–¥.
    }

    // –ø—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å XSS
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
